// ================================
// BOTÓN: Generar Lote
// FUNCIONALIDAD: Determina si hay solicitudes sin lote, si hay lote pendiente y si se debe generar uno nuevo o mostrar popup
// ================================

// 1. Buscar si existe un lote con estado pendiente
Set(
    varLotePendiente,
    LookUp(sng_Lotes, lote_Estado = "Pendiente")
);

// 2. Obtener todas las solicitudes aprobadas sin lote
ClearCollect(
    colSolicitudesAprobadasSinLote,
    ShowColumns(
        Filter(
            sng_solicitudes,
            sng_solicitudEstado = AppEstados.AprobadoAprobador1 && IsBlank(sng_loteID)
        ),
        sng_solicitudAprobador1Email,
        sng_solicitudAprobador1Nombre,
        sng_solicitudCosteEstimado,
        sng_solicitudBeneficiarioEmail,
        cr8bd_manager,
        Solicitudes
    )
);

// 3. Verificar si hay solicitudes para procesar
If(
    CountRows(colSolicitudesAprobadasSinLote) = 0,
    
    // Caso 3.1: No hay solicitudes aprobadas sin lote
    Notify("No hay solicitudes aprobadas sin lote. No se generó ningún lote.", NotificationType.Warning),
    
    // Caso 3.2: Sí hay solicitudes
    If(
        !IsBlank(varLotePendiente),
        
        // 3.2.1: Existe un lote pendiente → mostrar popup para decidir sobrescribir
        Set(varPopUpAlertaLote, true),
        
        // 3.2.2: No existe un lote pendiente → generar uno nuevo directamente
        Set(
            varLoteIDGenerado,
            Left(currentUser.userPrincipalName, Find("@", currentUser.userPrincipalName)) & Text(Now(), "yyymmdd-hhmm")
        );

        // Asignar lote a solicitudes
        ForAll(
            colSolicitudesAprobadasSinLote,
            Patch(
                sng_solicitudes,
                { Solicitudes: ThisRecord.Solicitudes },
                { sng_loteID: varLoteIDGenerado }
            )
        );

        // Recolectar solicitudes ya asociadas al nuevo lote
        ClearCollect(
            colSolicitudesConNuevoLote,
            Filter(sng_solicitudes, sng_loteID = varLoteIDGenerado)
        );

        // Agrupar y resumir por aprobador
        ClearCollect(
            colResumenPorAprobador,
            AddColumns(
                GroupBy(
                    colSolicitudesConNuevoLote,
                    cr8bd_manager,
                    Registros
                ),
                NombreManager, First(Registros).sng_solicitudAprobador1Nombre,
                TotalCosteEstimado, Sum(Registros, sng_solicitudCosteEstimado),
                Beneficiarios, Concat(Registros, sng_solicitudBeneficiarioEmail, ";"),
                FechaLote, Now(),
                ID, varLoteIDGenerado
            )
        );

        // Crear el nuevo lote
        ForAll(
            colResumenPorAprobador,
            Patch(
                sng_Lotes,
                Defaults(sng_Lotes),
                {
                    lote_LoteID: ID,
                    lote_Estado: "Pendiente",
                    lote_CantidadSolicitudes: CountRows(Registros),
                    lote_CreadoFecha: FechaLote,
                    lote_CreadoPorEmail: currentUser.userPrincipalName,
                    lote_CreadoPorNombre: currentUser.displayName,
                    lote_TotalCosteEstimado: TotalCosteEstimado
                }
            )
        )
    )
);


// ================================
// BOTÓN: Sí, Sobrescribir
// FUNCIONALIDAD: Reemplaza lote pendiente, genera nuevo lote y reasigna solicitudes
// ================================

// 1. Cambiar estado del lote pendiente a "Reemplazado"
Patch(
    sng_Lotes, 
    LookUp(sng_Lotes, lote_LoteID = varLotePendiente.lote_LoteID),
    {
        lote_Estado: "Reemplazado"
    }
);

// 2. Generar nuevo ID de lote
Set(
    varLoteIDGenerado,
    Left(currentUser.userPrincipalName, Find("@", currentUser.userPrincipalName)) & Text(Now(), "yyymmdd-hhmm")
);

// 3. Asignar nuevo lote a las solicitudes aprobadas sin lote
ForAll(
    colSolicitudesAprobadasSinLote,
    Patch(
        sng_solicitudes,
        { Solicitudes: ThisRecord.Solicitudes },
        { sng_loteID: varLoteIDGenerado }
    )
);

// 4. Recolectar todas las solicitudes asociadas al nuevo lote
ClearCollect(
    colSolicitudesConNuevoLote,
    Filter(sng_solicitudes, sng_loteID = varLoteIDGenerado)
);

// 5. Agrupar por aprobador y generar resumen
ClearCollect(
    colResumenPorAprobador,
    AddColumns(
        GroupBy(
            colSolicitudesConNuevoLote,
            cr8bd_manager,
            Registros
        ),
        NombreManager, First(Registros).sng_solicitudAprobador1Nombre,
        TotalCosteEstimado, Sum(Registros, sng_solicitudCosteEstimado),
        Beneficiarios, Concat(Registros, sng_solicitudBeneficiarioEmail, ";"),
        FechaLote, Now(),
        ID, varLoteIDGenerado
    )
);

// 6. Crear nuevo lote en Dataverse
ForAll(
    colResumenPorAprobador,
    Patch(
        sng_Lotes,
        Defaults(sng_Lotes),
        {
            lote_LoteID: ID,
            lote_Estado: "Pendiente",
            lote_CantidadSolicitudes: CountRows(Registros),
            lote_CreadoFecha: FechaLote,
            lote_CreadoPorEmail: currentUser.userPrincipalName,
            lote_CreadoPorNombre: currentUser.displayName,
            lote_TotalCosteEstimado: TotalCosteEstimado
        }
    )
);

// 7. Cerrar popup
Set(varPopUpAlertaLote, false);
